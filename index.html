<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ficha Deportiva</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        .container { max-width: 800px; margin: 2rem auto; padding: 2rem; background-color: #ffffff; border-radius: 1.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);}
        h2 { border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1.5rem; color: #1f2937;}
        label { font-weight: 500; color: #4b5563;}
        input[type="text"], input[type="date"], input[type="number"], input[type="email"], textarea, select {
            width: 100%; padding: 0.75rem; border-radius: 0.75rem; border: 1px solid #d1d5db; background-color: #f9fafb; transition: all 0.2s ease-in-out;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, input[type="email"]:focus, textarea:focus, select:focus {
            outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        .button { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; cursor: pointer; border: none;}
        .button-primary { padding: 0.75rem 1.5rem; border-radius: 0.75rem; background-color: #1d4ed8; color: #ffffff;}
        .button-primary:hover { background-color: #1e40af;}
        .button-secondary { background-color: #6b7280; color: white;}
        .button-secondary:hover { background-color: #4b5563;}
        .button-danger { background-color: #dc2626; color: white;}
        .button-danger:hover { background-color: #b91c1c;}
        .rotate-90 { transform: rotate(90deg);}
        .transition-transform { transition: transform 0.2s;}
        /* Notificación flotante */
        #floatingNotification {
            position: fixed;
            top: 32px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            min-width: 220px;
            display: none;
        }
    </style>
    <!-- Firebase scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 p-6">
    <div class="container mx-auto p-8 bg-white rounded-3xl shadow-lg">
        <h1 class="text-3xl font-bold text-center mb-6">Ficha del Deportista</h1>
        <div id="statusMessage" class="text-center mb-4 hidden"></div>
        <!-- Notificación flotante -->
        <div id="floatingNotification" class="bg-green-600 text-white px-6 py-3 rounded-xl shadow-lg text-lg font-semibold"></div>
        <div id="customConfirmModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-lg text-center max-w-sm mx-auto">
                <p id="customConfirmText" class="mb-4 text-lg"></p>
                <div class="flex justify-center space-x-4">
                    <button id="customConfirmYes" class="button button-danger">Sí</button>
                    <button id="customConfirmNo" class="button button-secondary">No</button>
                </div>
            </div>
        </div>
        <p id="userIdDisplay" class="text-sm text-center text-gray-500 mb-6 hidden"></p>

        <!-- Login/Register -->
        <div id="loginContainer" class="container mx-auto p-8 bg-white rounded-3xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold mb-4">Iniciar Sesión</h2>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" placeholder="Correo" class="rounded-xl w-full p-2 border" required>
                <input type="password" id="loginPassword" placeholder="Contraseña" class="rounded-xl w-full p-2 border" required>
                <div class="flex gap-2">
                    <button type="submit" class="button button-primary flex-1">Entrar</button>
                    <button type="button" id="registerBtn" class="button button-secondary flex-1">Registrarse</button>
                </div>
            </form>
        </div>
        <div class="flex justify-end mb-4">
            <button id="logoutBtn" class="button button-secondary hidden">Cerrar sesión</button>
        </div>

        <!-- Formulario de entrada de datos -->
        <form id="deportistaForm" class="space-y-6">
            <input type="hidden" id="editingDeportistaId">
            <!-- Sección de Datos Personales -->
            <div class="p-6 bg-gray-50 rounded-2xl">
                <h2 class="text-2xl font-semibold mb-4">Datos Personales</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="apellido" class="block mb-2 text-sm">Apellido</label>
                        <input type="text" id="apellido" name="apellido" class="rounded-xl" placeholder="Ej: Pérez" required>
                    </div>
                    <div>
                        <label for="nombre" class="block mb-2 text-sm">Nombre</label>
                        <input type="text" id="nombre" name="nombre" class="rounded-xl" placeholder="Ej: Juan" required>
                    </div>
                    <div>
                        <label for="fechaNacimiento" class="block mb-2 text-sm">Fecha de Nacimiento</label>
                        <input type="date" id="fechaNacimiento" name="fechaNacimiento" class="rounded-xl">
                    </div>
                    <div>
                        <label for="telefono" class="block mb-2 text-sm">Teléfono de contacto</label>
                        <input type="text" id="telefono" name="telefono" class="rounded-xl" placeholder="Ej: 341 1234567">
                    </div>
                    <div>
                        <label for="email" class="block mb-2 text-sm">Correo electrónico</label>
                        <input type="email" id="email" name="email" class="rounded-xl" placeholder="ejemplo@correo.com">
                    </div>
                    <div>
                        <label for="nombreEmergencia" class="block mb-2 text-sm">Contacto de emergencia (Nombre)</label>
                        <input type="text" id="nombreEmergencia" name="nombreEmergencia" class="rounded-xl" placeholder="Ej: María González">
                    </div>
                    <div>
                        <label for="telefonoEmergencia" class="block mb-2 text-sm">Contacto de emergencia (Teléfono)</label>
                        <input type="text" id="telefonoEmergencia" name="telefonoEmergencia" class="rounded-xl" placeholder="Ej: 341 7654321">
                    </div>
                </div>
            </div>
            <!-- Sección de Datos Físicos -->
            <div class="p-6 bg-gray-50 rounded-2xl">
                <h2 class="text-2xl font-semibold mb-4">Datos Físicos</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="altura" class="block mb-2 text-sm">Altura (cm)</label>
                        <input type="number" id="altura" name="altura" class="rounded-xl" placeholder="Ej: 190">
                    </div>
                    <div>
                        <label for="peso" class="block mb-2 text-sm">Peso (kg)</label>
                        <input type="number" id="peso" name="peso" class="rounded-xl" placeholder="Ej: 85">
                    </div>
                    <div>
                        <label for="posicion" class="block mb-2 text-sm">Posición</label>
                        <select id="posicion" name="posicion" class="rounded-xl">
                            <option value="">Seleccionar...</option>
                            <option value="Base">Base</option>
                            <option value="Escolta">Escolta</option>
                            <option value="Alero">Alero</option>
                            <option value="Ala-Pivot">Ala-Pivot</option>
                            <option value="Pivot">Pivot</option>
                        </select>
                    </div>
                    <div>
                        <label for="miembroDominante" class="block mb-2 text-sm">Miembro dominante</label>
                        <select id="miembroDominante" name="miembroDominante" class="rounded-xl">
                            <option value="">Seleccionar...</option>
                            <option value="Derecho">Derecho</option>
                            <option value="Izquierdo">Izquierdo</option>
                        </select>
                    </div>
                </div>
            </div>
            <!-- Sección de Historia Clínica -->
            <div class="p-6 bg-gray-50 rounded-2xl">
                <h2 class="text-2xl font-semibold mb-4">Historia Clínica</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="alergias" class="block mb-2 text-sm">Alergias</label>
                        <input type="text" id="alergias" name="alergias" class="rounded-xl" placeholder="Medicamentos, alimentos, etc.">
                    </div>
                    <div>
                        <label for="medicamentosActuales" class="block mb-2 text-sm">Medicamentos actuales</label>
                        <textarea id="medicamentosActuales" name="medicamentosActuales" rows="2" class="rounded-xl" placeholder="Dosis y motivo"></textarea>
                    </div>
                </div>
                <div class="mt-4">
                    <label for="antecedentesFamiliares" class="block mb-2 text-sm">Antecedentes familiares</label>
                    <textarea id="antecedentesFamiliares" name="antecedentesFamiliares" rows="2" class="rounded-xl" placeholder="Ej: historial de diabetes, enfermedades cardiacas"></textarea>
                </div>
                <div class="mt-4">
                    <label for="observaciones" class="block mb-2 text-sm">Observaciones</label>
                    <textarea id="observaciones" name="observaciones" rows="2" class="rounded-xl" placeholder="Ej: nota sobre la condición física o emocional del deportista"></textarea>
                </div>
                <div id="lesionesContainer" class="space-y-4 mt-6">
                    <h3 class="text-lg font-semibold">Historial de Lesiones</h3>
                </div>
                <button type="button" id="addLesionBtn" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    + Añadir Lesión
                </button>
            </div>
            <div class="flex items-center space-x-4">
                <button type="submit" id="submitBtn" class="button button-primary flex-1">Guardar Deportista</button>
                <button type="button" id="cancelBtn" class="button button-secondary flex-1 hidden">Cancelar Edición</button>
            </div>
        </form>
        <!-- Área para mostrar la lista de deportistas guardados -->
        <div id="deportistasList" class="mt-8 p-6 bg-gray-50 rounded-2xl">
            <h2 class="text-2xl font-semibold mb-4">Deportistas Guardados</h2>
            <div id="deportistasContent">
                <p class="text-gray-500 text-center">Cargando deportistas...</p>
            </div>
        </div>
    </div>
    <!-- Modal de confirmación para eliminar (no se usa, pero se deja por si quieres mantenerlo) -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center max-w-sm mx-auto">
            <p class="mb-4 text-lg">¿Estás seguro de que deseas eliminar esta ficha?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteBtn" class="button button-danger">Eliminar</button>
                <button id="cancelDeleteBtn" class="button button-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    <script>
    // --- Firebase config ---
    const firebaseConfig = {
      apiKey: "AIzaSyDxbaXZMSqA5X0UuGTKcw8QjTIfAGsZ3kg",
      authDomain: "ficha-deportistas.firebaseapp.com",
      projectId: "ficha-deportistas",
      storageBucket: "ficha-deportistas.firebasestorage.app",
      messagingSenderId: "923755222459",
      appId: "1:923755222459:web:2e1d1160d486dc15c4a09e"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- UI y lógica de autenticación ---
    const loginContainer = document.getElementById('loginContainer');
    const loginForm = document.getElementById('loginForm');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const deportistaForm = document.getElementById('deportistaForm');
    const deportistasList = document.getElementById('deportistasList');
    const userIdDisplay = document.getElementById('userIdDisplay');
    const statusDiv = document.getElementById('statusMessage');

    // Modal de confirmación personalizada
    function customConfirm(message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('customConfirmModal');
            const text = document.getElementById('customConfirmText');
            const yesBtn = document.getElementById('customConfirmYes');
            const noBtn = document.getElementById('customConfirmNo');
            text.textContent = message;
            modal.classList.remove('hidden');
            function cleanup(result) {
                modal.classList.add('hidden');
                yesBtn.removeEventListener('click', onYes);
                noBtn.removeEventListener('click', onNo);
                resolve(result);
            }
            function onYes() { cleanup(true); }
            function onNo() { cleanup(false); }
            yesBtn.addEventListener('click', onYes);
            noBtn.addEventListener('click', onNo);
        });
    }

    function showStatusMessage(msg, type = "success", duration = 2000) {
        statusDiv.textContent = msg;
        statusDiv.className = `text-center mb-4 ${type === "success" ? "text-green-700 bg-green-100" : "text-red-700 bg-red-100"} py-2 rounded-xl`;
        statusDiv.classList.remove('hidden');
        setTimeout(() => {
            statusDiv.classList.add('hidden');
        }, duration);
    }

    function showFloatingNotification(msg, type = "success", duration = 2000) {
        const notif = document.getElementById('floatingNotification');
        notif.textContent = msg;
        notif.className = `bg-${type === "success" ? "green" : "red"}-600 text-white px-6 py-3 rounded-xl shadow-lg text-lg font-semibold`;
        notif.style.display = "block";
        setTimeout(() => {
            notif.style.display = "none";
        }, duration);
    }

    function showLogin() {
        loginContainer.style.display = '';
        deportistaForm.style.display = 'none';
        deportistasList.style.display = 'none';
        logoutBtn.classList.add('hidden');
        userIdDisplay.classList.add('hidden');
    }
    function showApp(user) {
        loginContainer.style.display = 'none';
        deportistaForm.style.display = '';
        deportistasList.style.display = '';
        logoutBtn.classList.remove('hidden');
        userIdDisplay.classList.remove('hidden');
        userIdDisplay.textContent = `Usuario: ${user.email}`;
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            showApp(user);
            setupDynamicFields();
            renderDeportistas();
        } else {
            showLogin();
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
            await auth.signInWithEmailAndPassword(email, password);
        } catch (err) {
            showStatusMessage('Error de login: ' + err.message, "error", 4000);
        }
    });
    registerBtn.addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        if (!email || !password) return showStatusMessage('Completa email y contraseña', "error", 3000);
        try {
            await auth.createUserWithEmailAndPassword(email, password);
            showStatusMessage('Usuario registrado. Ya puedes usar la app.');
        } catch (err) {
            showStatusMessage('Error al registrar: ' + err.message, "error", 4000);
        }
    });
    logoutBtn.addEventListener('click', () => auth.signOut());

    // --- Firestore CRUD ---
    function getUserCollection() {
        const user = auth.currentUser;
        if (!user) throw new Error("No user logged in");
        return db.collection('users').doc(user.uid).collection('deportistas');
    }
    function addDeportista(data) {
        return getUserCollection().add(data);
    }
    function getAllDeportistas() {
        return getUserCollection().get().then(snapshot => snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
    }
    function updateDeportista(id, data) {
        return getUserCollection().doc(id).set(data);
    }
    function deleteDeportista(id) {
        return getUserCollection().doc(id).delete();
    }
    function getDeportista(id) {
        return getUserCollection().doc(id).get().then(doc => doc.exists ? doc.data() : null);
    }

    // --- UI lógica ---
    let lesionCount = 0;
    let deportistaToDeleteId = null;

    const form = deportistaForm;
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const editingDeportistaIdInput = document.getElementById('editingDeportistaId');
    const addLesionBtn = document.getElementById('addLesionBtn');
    const lesionesContainer = document.getElementById('lesionesContainer');
    const deportistasContent = document.getElementById('deportistasContent');
    const confirmationModal = document.getElementById('confirmationModal');
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');

    form.addEventListener('submit', handleFormSubmit);
    cancelBtn.addEventListener('click', resetForm);

    form.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') e.preventDefault();
    });

    async function handleFormSubmit(e) {
        e.preventDefault();
        const deportistaData = buildDeportistaData();
        const editingId = editingDeportistaIdInput.value;
        try {
            if (editingId) {
                const ok = await customConfirm("¿Deseas modificar este jugador?");
                if (!ok) return showStatusMessage("Modificación cancelada.", "error");
                await updateDeportista(editingId, deportistaData);
                showFloatingNotification("¡Jugador modificado correctamente!");
            } else {
                await addDeportista(deportistaData);
                showFloatingNotification("¡Jugador guardado correctamente!");
            }
            resetForm();
            setTimeout(renderDeportistas, 1200);
        } catch (error) {
            showStatusMessage("Error al guardar: " + error, "error", 4000);
        }
    }

    function createLesionFields(index, data = {}) {
        const { fecha = '', zona = '', descripcion = '' } = data;
        const div = document.createElement('div');
        div.className = 'p-4 bg-gray-100 rounded-lg border border-gray-200 relative';
        div.innerHTML = `
            <button type="button" class="absolute top-2 right-2 text-red-600 font-bold text-lg remove-lesion-btn" title="Eliminar lesión" data-index="${index}">&times;</button>
            <h4 class="text-md font-semibold mb-2">Lesión ${index + 1}</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="fechaLesion${index}" class="block mb-1 text-sm">Fecha</label><input type="date" id="fechaLesion${index}" value="${fecha}" class="rounded-xl"></div>
                <div><label for="zonaLesion${index}" class="block mb-1 text-sm">Zona</label><input type="text" id="zonaLesion${index}" name="zonaLesion${index}" value="${zona}" class="rounded-xl"></div>
            </div>
            <div class="mt-2"><label for="descripcionLesion${index}" class="block mb-1 text-sm">Descripción</label><textarea id="descripcionLesion${index}" name="descripcionLesion${index}" rows="2" class="rounded-xl">${descripcion}</textarea></div>
        `;
        lesionesContainer.appendChild(div);
        div.querySelector('.remove-lesion-btn').onclick = function() {
            div.remove();
            updateLesionIndices();
        };
    }
    function updateLesionIndices() {
        const lesionDivs = lesionesContainer.querySelectorAll('.p-4.bg-gray-100');
        lesionDivs.forEach((div, i) => {
            div.querySelector('h4').textContent = `Lesión ${i + 1}`;
            div.querySelector('.remove-lesion-btn').setAttribute('data-index', i);
            div.querySelector('input[type="date"]').id = `fechaLesion${i}`;
            div.querySelector('input[type="text"]').id = `zonaLesion${i}`;
            div.querySelector('input[type="text"]').name = `zonaLesion${i}`;
            div.querySelector('textarea').id = `descripcionLesion${i}`;
            div.querySelector('textarea').name = `descripcionLesion${i}`;
        });
        lesionCount = lesionDivs.length;
    }
    function buildDeportistaData() {
        const data = {
            nombre: form.nombre.value,
            apellido: form.apellido.value,
            fechaNacimiento: form.fechaNacimiento.value,
            telefono: form.telefono.value,
            email: form.email.value,
            nombreEmergencia: form.nombreEmergencia.value,
            telefonoEmergencia: form.telefonoEmergencia.value,
            altura: form.altura.value,
            peso: form.peso.value,
            posicion: form.posicion.value,
            miembroDominante: form.miembroDominante.value,
            alergias: form.alergias.value,
            medicamentosActuales: form.medicamentosActuales.value,
            antecedentesFamiliares: form.antecedentesFamiliares.value,
            observaciones: form.observaciones.value,
            lesiones: [],
            updatedAt: new Date().toISOString()
        };
        const lesionDivs = lesionesContainer.querySelectorAll('.p-4.bg-gray-100');
        lesionDivs.forEach((div, i) => {
            const fecha = div.querySelector(`input[type="date"]`)?.value;
            const zona = div.querySelector(`input[type="text"]`)?.value;
            const descripcion = div.querySelector(`textarea`)?.value;
            if (fecha || zona || descripcion) data.lesiones.push({ fecha, zona, descripcion });
        });
        return data;
    }
    function formatearFecha(fecha) {
        if (!fecha) return 'N/A';
        const [anio, mes, dia] = fecha.split('-');
        if (!anio || !mes || !dia) return 'N/A';
        return `${dia}-${mes}-${anio}`;
    }
    function calcularEdad(fechaNacimiento) {
        if (!fechaNacimiento) return 'N/A';
        const hoy = new Date();
        const nacimiento = new Date(fechaNacimiento);
        let edad = hoy.getFullYear() - nacimiento.getFullYear();
        const m = hoy.getMonth() - nacimiento.getMonth();
        if (m < 0 || (m === 0 && hoy.getDate() < nacimiento.getDate())) {
            edad--;
        }
        return edad;
    }
    function renderList(items, type) {
        if (!items || items.length === 0) return `<li>No se han registrado ${type}.</li>`;
        return items.map(item => `
            <li>
                <span class="font-semibold">${item.zona || 'N/A'}</span>
                ${item.descripcion ? `- ${item.descripcion}` : ''}
                <span class="ml-2 px-2 py-0.5 rounded text-white bg-blue-700 font-bold text-xs align-middle">${formatearFecha(item.fecha)}</span>
            </li>
        `).join('');
    }
    deportistasContent.addEventListener('click', (e) => {
        const header = e.target.closest('.ficha-header');
        if (header) {
            const fichaId = header.getAttribute('data-ficha');
            const body = document.getElementById(fichaId);
            const icon = header.querySelector('.expand-icon');
            if (body) body.classList.toggle('hidden');
            if (icon) icon.classList.toggle('rotate-90');
            return;
        }
        const target = e.target.closest('button');
        if (!target) return;
        const id = target.dataset.id;
        if (target.classList.contains('modify-btn')) {
            startEditing(id);
        } else if (target.classList.contains('delete-btn')) {
            deportistaToDeleteId = id;
            customConfirm("¿Deseas eliminar este jugador?").then(ok => {
                if (ok) {
                    deleteDeportista(deportistaToDeleteId)
                        .then(() => {
                            showFloatingNotification("¡Jugador eliminado correctamente!");
                            setTimeout(renderDeportistas, 1200);
                        })
                        .catch(error => {
                            showStatusMessage("Error al eliminar deportista: " + error, "error", 4000);
                        })
                        .finally(() => {
                            deportistaToDeleteId = null;
                        });
                } else {
                    deportistaToDeleteId = null;
                    showStatusMessage("Eliminación cancelada.", "error");
                }
            });
        }
    });
    async function startEditing(id) {
        const ok = await customConfirm("¿Deseas editar este jugador?");
        if (!ok) {
            showStatusMessage("Edición cancelada.", "error");
            return;
        }
        try {
            const deportista = await getDeportista(id);
            if (!deportista) return;
            Object.keys(deportista).forEach(key => {
                const el = form.elements[key];
                if (el) el.value = deportista[key];
            });
            if (form.apellido) form.apellido.value = deportista.apellido || '';
            if (form.nombre) form.nombre.value = deportista.nombre || '';
            resetDynamicFields(lesionesContainer, 'Historial de Lesiones', createLesionFields);
            lesionesContainer.innerHTML = `<h3 class="text-lg font-semibold">Historial de Lesiones</h3>`;
            lesionCount = 0;
            if (deportista.lesiones && deportista.lesiones.length > 0) {
                deportista.lesiones.forEach(item => { createLesionFields(lesionCount, item); lesionCount++; });
            } else {
                createLesionFields(0);
                lesionCount = 1;
            }
            editingDeportistaIdInput.value = id;
            submitBtn.textContent = 'Actualizar Deportista';
            cancelBtn.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            showStatusMessage("Modo edición activado.", "success", 1500);
        } catch (error) {
            showStatusMessage("Error al cargar datos para editar: " + error, "error", 4000);
        }
    }
    function resetDynamicFields(container, title, createFn) {
        container.innerHTML = `<h3 class="text-lg font-semibold">${title}</h3>`;
        createFn(0);
    }
    function setupDynamicFields() {
        addLesionBtn.addEventListener('click', () => { createLesionFields(lesionCount); lesionCount++; });
        resetForm();
    }
    function resetForm() {
        form.reset();
        editingDeportistaIdInput.value = '';
        submitBtn.textContent = 'Guardar Deportista';
        cancelBtn.classList.add('hidden');
        resetDynamicFields(lesionesContainer, 'Historial de Lesiones', createLesionFields);
        lesionCount = 1;
    }
    function renderSingleDeportista(d) {
        const fichaId = `ficha-${d.id}`;
        const nombreCompleto = `${d.apellido || ''}, ${d.nombre || ''}`;
        const imc = (d.altura > 0 && d.peso > 0) ? (d.peso / ((d.altura/100)**2)).toFixed(2) : 'N/A';

        function showField(label, value) {
            if (!value) return '';
            return `<p class="text-sm text-gray-600"><span class="font-semibold">${label}:</span> ${value}</p>`;
        }

        return `
    <div class="deportista-ficha border rounded mb-2 overflow-hidden">
        <div class="ficha-header bg-blue-100 cursor-pointer flex justify-between items-center px-4 py-2" data-ficha="${fichaId}">
            <span class="font-bold text-blue-900">${nombreCompleto}</span>
            <span class="expand-icon transition-transform ml-2">&#9654;</span>
        </div>
        <div id="${fichaId}" class="ficha-body hidden bg-white px-4 pb-4">
            <div class="p-6 my-4 bg-white rounded-xl shadow-md border border-gray-200 space-y-3">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="text-xl font-bold text-blue-800">${nombreCompleto}</h3>
                        ${showField('Edad', d.fechaNacimiento ? calcularEdad(d.fechaNacimiento) + ' años' : '')}
                    </div>
                    <div class="flex space-x-2">
                         <button class="button button-secondary text-xs modify-btn" data-id="${d.id}">Modificar</button>
                         <button class="button button-danger text-xs delete-btn" data-id="${d.id}">Eliminar</button>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold text-gray-700">Datos Personales</h4>
                    ${showField('Teléfono', d.telefono)}
                    ${showField('Email', d.email)}
                    ${showField('Contacto de emergencia', d.nombreEmergencia)}
                    ${showField('Teléfono de emergencia', d.telefonoEmergencia)}
                    ${showField('Fecha de nacimiento', d.fechaNacimiento)}
                </div>
                <div>
                   <h4 class="font-bold text-gray-700 mt-2">Datos Físicos</h4>
                   ${showField('Altura', d.altura ? d.altura + ' cm' : '')}
                   ${showField('Peso', d.peso ? d.peso + ' kg' : '')}
                   ${showField('IMC', imc !== 'N/A' ? imc : '')}
                   ${showField('Posición', d.posicion)}
                   ${showField('Miembro dominante', d.miembroDominante)}
                </div>
                <div>
                    <h4 class="font-bold text-gray-700 mt-2">Historia Clínica</h4>
                    ${showField('Alergias', d.alergias)}
                    ${showField('Medicamentos actuales', d.medicamentosActuales)}
                    ${showField('Antecedentes familiares', d.antecedentesFamiliares)}
                    ${showField('Observaciones', d.observaciones)}
                    <h5 class="font-semibold text-gray-700 mt-2">Lesiones:</h5>
                    <ul class="list-disc list-inside text-sm text-gray-600">${renderList(d.lesiones, 'lesiones')}</ul>
                </div>
            </div>
        </div>
    </div>`;
    }
    async function renderDeportistas() {
        try {
            const deportistas = await getAllDeportistas();
            if (deportistas.length === 0) {
                deportistasContent.innerHTML = `<p class="text-gray-500 text-center">No hay deportistas guardados aún.</p>`;
                return;
            }
            deportistas.sort((a, b) => {
                const apA = (a.apellido || '').toLowerCase();
                const apB = (b.apellido || '').toLowerCase();
                if (apA < apB) return -1;
                if (apA > apB) return 1;
                return 0;
            });
            deportistasContent.innerHTML = deportistas.map(d => renderSingleDeportista(d)).join('');
        } catch (err) {
            deportistasContent.innerHTML = `<p class="text-red-500 text-center">Error al cargar deportistas.</p>`;
        }
    }
    </script>
</body>
</html>
